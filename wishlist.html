<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="FlipSide - Your saved premium products.">
    <title>Wishlist - FlipSide</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/favicon.png?v=3">
    <link rel="shortcut icon" type="image/png" href="assets/favicon.png?v=3">

    <!-- Firebase SDK (Added for Reviews & Social Proof) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav>
        <div class="container">
            <div class="nav-container">
                <a href="index.html" class="nav-logo">
                    <img src="assets/logo.png" alt="FlipSide Logo">
                    <span>FlipSide</span>
                </a>

                <ul class="nav-links" id="navLinks">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="reseller.html">Become a Reseller</a></li>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="track.html">Orders</a></li>
                </ul>

                <div class="nav-cta">
                    <button class="btn btn-ghost" id="themeToggle" title="Toggle Light/Dark Mode"
                        style="font-size: 1.2rem; padding: 0.5rem;">‚òÄÔ∏è</button>
                    <a href="wishlist.html" class="btn btn-ghost cart-badge active" id="wishlistBtn" title="Wishlist">
                        ‚ù§Ô∏è <span>Wishlist</span>
                        <span class="cart-badge-count" id="wishlistCount">0</span>
                    </a>
                    <button class="btn btn-ghost cart-badge" id="cartBtn">
                        üõí <span>Shop</span>
                        <span class="cart-badge-count" id="cartCount">0</span>
                    </button>
                    <a href="admin.html" class="btn btn-outline btn-small">Admin</a>
                </div>

                <button class="menu-toggle" id="menuToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Wishlist Header -->
    <section class="section" style="padding-top: 120px; background: var(--color-bg-darker);">
        <div class="container">
            <div style="text-align: center; margin-bottom: var(--spacing-2xl);">
                <h1 style="font-size: 3rem; margin-bottom: var(--spacing-md);">Your Wishlist</h1>
                <p style="color: var(--color-text-secondary); max-width: 600px; margin: 0 auto;">
                    Saved items you love. Add them to your cart when you're ready!
                </p>
            </div>

            <!-- Wishlist Items -->
            <div id="wishlistGrid" class="products-grid">
                <!-- Dynamically populated -->
            </div>

            <!-- Empty State -->
            <div id="emptyWishlist" class="card card-glass hidden"
                style="text-align: center; padding: var(--spacing-2xl);">
                <div style="font-size: 4rem; margin-bottom: var(--spacing-lg);">ü§ç</div>
                <h2 style="margin-bottom: var(--spacing-md);">Your wishlist is empty</h2>
                <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-xl);">
                    Browse our collection and save items you like for later!
                </p>
                <a href="products.html" class="btn btn-primary">Start Shopping</a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-column">
                    <h3>FlipSide</h3>
                    <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-md);">
                        Your trusted platform for premium reselling opportunities.
                    </p>
                    <div class="footer-social" id="footerSocial">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="products.html">Products</a></li>
                        <li><a href="reseller.html">Become a Reseller</a></li>
                        <li><a href="dashboard.html">Dashboard</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h3>Support</h3>
                    <ul class="footer-links">
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="index.html#shipping">Shipping Info</a></li>
                        <li><a href="returns.html">Returns</a></li>
                        <li><a href="index.html#contact">Contact Us</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h3>Contact</h3>
                    <ul class="footer-links">
                        <li id="footerEmail">üìß <a
                                href="mailto:muzincorporations@gmail.com">muzincorporations@gmail.com</a></li>
                        <li id="footerPhone" class="hidden">üì± <span></span></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2026 FlipSide. All rights reserved. Built for success.</p>
            </div>
        </div>
    </footer>

    <!-- Product Detail Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal product-detail-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalProductName">Product Details</h3>
                <button class="modal-close" onclick="closeProductModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="product-detail-grid">
                    <div class="product-detail-gallery">
                        <img src="" alt="" id="modalProductImage" class="product-main-img"
                            onerror="this.src='https://via.placeholder.com/400x400/1a1a1a/FFD700?text=Image+Not+Found'">
                    </div>
                    <div class="product-detail-info">
                        <div class="product-card-category" id="modalProductCategory">CATEGORY</div>
                        <h2 class="product-info-title" id="modalProductTitle">Product Title</h2>
                        <div class="product-info-price" id="modalProductPrice">¬£0.00</div>

                        <div class="product-info-meta">
                            <span class="badge badge-digital" id="modalProductType">Digital</span>
                            <span class="badge badge-sale" id="modalProductSale" style="display:none">Sale</span>
                        </div>

                        <div class="product-info-desc" id="modalProductDesc"></div>

                        <div class="product-info-actions">
                            <button class="btn btn-primary" id="modalAddToCart">Add to Cart</button>
                            <button class="btn btn-outline" id="modalToggleWishlist">Remove from Wishlist</button>
                        </div>

                        <!-- FOMO Dispatch Timer -->
                        <div id="modalFomoTimer" class="fomo-timer">
                            Order within <span class="fomo-timer-clock">...</span> for same-day dispatch!
                        </div>

                        <!-- Share Suite -->
                        <div class="modal-share-suite">
                            <button class="share-btn whatsapp" id="shareWhatsApp">
                                <span>Share on WhatsApp</span>
                            </button>
                            <button class="share-btn twitter" id="shareTwitter">
                                <span>Share on Twitter</span>
                            </button>
                        </div>

                        <!-- Reviews Section -->
                        <div class="product-reviews-section">
                            <div class="reviews-header">
                                <h3>Customer Reviews</h3>
                                <div id="averageRating" class="star-rating">
                                    <span>Average:</span>
                                    <div class="stars" id="modalAverageStars"></div>
                                </div>
                            </div>

                            <div id="reviewsList">
                                <!-- Reviews dynamically loaded here -->
                            </div>

                            <button class="btn btn-ghost btn-small" onclick="toggleReviewForm()" id="writeReviewBtn">
                                ‚úçÔ∏è Write a Review
                            </button>

                            <div id="reviewFormContainer" class="add-review-form hidden">
                                <h4>Share your experience</h4>
                                <div class="rating-selector">
                                    <span>Rating:</span>
                                    <div id="ratingSelector" class="star-rating interactive">
                                        <span data-value="1" class="star">‚òÖ</span>
                                        <span data-value="2" class="star">‚òÖ</span>
                                        <span data-value="3" class="star">‚òÖ</span>
                                        <span data-value="4" class="star">‚òÖ</span>
                                        <span data-value="5" class="star">‚òÖ</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="reviewName" class="form-input" placeholder="Your Name">
                                </div>
                                <div class="form-group">
                                    <textarea id="reviewComment" class="form-input" rows="3"
                                        placeholder="What did you think of this product?"></textarea>
                                </div>
                                <button class="btn btn-primary btn-small" onclick="submitReview()">Submit
                                    Review</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/brand-settings.js"></script>
    <script src="js/config.js"></script>
    <script src="js/products.js"></script>
    <script src="js/firebase.js"></script>
    <script>
        // Menu Toggle
        const menuToggle = document.getElementById('menuToggle');
        const navLinks = document.getElementById('navLinks');

        if (menuToggle && navLinks) {
            menuToggle.addEventListener('click', () => {
                menuToggle.classList.toggle('active');
                navLinks.classList.toggle('active');
            });
        }

        // Initialize counts
        function updateCounts() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            document.getElementById('cartCount').textContent = cart.length;
            const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
            document.getElementById('wishlistCount').textContent = wishlist.length;
        }

        function displayWishlist() {
            const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
            const container = document.getElementById('wishlistGrid');
            const emptyState = document.getElementById('emptyWishlist');

            if (wishlist.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            const items = wishlist.map(id => getProductById(id)).filter(p => p !== null);

            container.innerHTML = items.map(product => {
                const price = getFinalPrice(product);
                return `
                    <div class="product-card fade-in" onclick="openProductModal(${product.id})">
                        <div class="product-card-image">
                            <img src="${product.image}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/400x400/1a1a1a/FFD700?text=${encodeURIComponent(product.name)}'">
                            <div class="wishlist-btn active" onclick="event.stopPropagation(); toggleWishlist(${product.id})">‚ù§Ô∏è</div>
                        </div>
                        <div class="product-card-body">
                            <div class="product-card-category">${product.category}</div>
                            <h3 class="product-card-title">${product.name}</h3>
                            <div class="product-card-rating" id="rating-card-${product.id}" style="font-size: 0.75rem; color: var(--color-gold); margin-bottom: 5px;">
                                ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Verified)
                            </div>
                            <div class="product-card-footer">
                                <div class="product-price">
                                    <div class="product-price-current">¬£${price.toFixed(2)}</div>
                                </div>
                                <button class="btn btn-primary btn-small btn-premium" onclick="event.stopPropagation(); addToCart(${product.id})">Add to Cart</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleWishlist(productId) {
            let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
            const index = wishlist.indexOf(productId);
            if (index > -1) {
                wishlist.splice(index, 1);
                showToast('Removed from wishlist', 'info');
            } else {
                wishlist.push(productId);
                showToast('Added to wishlist!', 'success');
            }
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            updateCounts();
            displayWishlist();
        }

        function addToCart(productId) {
            const product = getProductById(productId);
            if (!product) return;
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.find(i => i.id === productId)) {
                showToast('Already in cart!', 'error');
                return;
            }
            cart.push({
                id: product.id,
                name: product.name,
                price: getFinalPrice(product),
                image: product.image,
                type: product.type
            });
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCounts();
            showToast('Added to cart!', 'success');

            // Cart bounce animation
            const cartIcon = document.getElementById('cartCount');
            if (cartIcon) {
                cartIcon.classList.remove('cart-icon-animate');
                void cartIcon.offsetWidth; // Trigger reflow
                cartIcon.classList.add('cart-icon-animate');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<p class="toast-message">${message}</p>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Modal functions
        async function openProductModal(productId) {
            const product = getProductById(productId);
            if (!product) return;
            const modal = document.getElementById('productModal');
            document.getElementById('modalProductImage').src = product.image;
            document.getElementById('modalProductCategory').textContent = product.category;
            document.getElementById('modalProductTitle').textContent = product.name;
            document.getElementById('modalProductPrice').textContent = `¬£${getFinalPrice(product).toFixed(2)}`;
            document.getElementById('modalProductDesc').innerHTML = product.description.replace(/\n/g, '<br>');

            document.getElementById('modalAddToCart').onclick = () => {
                addToCart(product.id);
                closeProductModal();
            };

            wishBtn.onclick = () => {
                toggleWishlist(product.id);
                closeProductModal();
            };

            // FOMO Timer
            if (typeof updateDispatchTimer === 'function') {
                updateDispatchTimer('modalFomoTimer');
            }

            // Share Suite
            const shareWhatsApp = document.getElementById('shareWhatsApp');
            const shareTwitter = document.getElementById('shareTwitter');
            if (shareWhatsApp) shareWhatsApp.onclick = () => shareProduct('whatsapp', product.name, product.id);
            if (shareTwitter) shareTwitter.onclick = () => shareProduct('twitter', product.name, product.id);

            // Review Logic
            modal.dataset.productId = productId;
            loadModalReviews(productId);
            resetReviewForm();

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // --- Review & Rating Logic ---

        function toggleReviewForm() {
            const container = document.getElementById('reviewFormContainer');
            const btn = document.getElementById('writeReviewBtn');
            container.classList.toggle('hidden');
            btn.textContent = container.classList.contains('hidden') ? '‚úçÔ∏è Write a Review' : '‚úñ Cancel Review';
        }

        function resetReviewForm() {
            document.getElementById('reviewFormContainer').classList.add('hidden');
            document.getElementById('writeReviewBtn').textContent = '‚úçÔ∏è Write a Review';
            document.getElementById('reviewName').value = '';
            document.getElementById('reviewComment').value = '';
            const stars = document.querySelectorAll('#ratingSelector .star');
            stars.forEach(s => {
                s.classList.add('empty');
                s.textContent = '‚òÜ';
            });
            window.currentRating = 0;
        }

        // Star Rating Selection
        document.addEventListener('click', (e) => {
            if (e.target.closest('#ratingSelector .star')) {
                const val = parseInt(e.target.dataset.value);
                window.currentRating = val;
                const stars = document.querySelectorAll('#ratingSelector .star');
                stars.forEach(s => {
                    const sVal = parseInt(s.dataset.value);
                    if (sVal <= val) {
                        s.classList.remove('empty');
                        s.textContent = '‚òÖ';
                    } else {
                        s.classList.add('empty');
                        s.textContent = '‚òÜ';
                    }
                });
            }
        });

        async function submitReview() {
            const modal = document.getElementById('productModal');
            const productId = modal.dataset.productId;
            const name = document.getElementById('reviewName').value.trim();
            const comment = document.getElementById('reviewComment').value.trim();
            const rating = window.currentRating || 0;

            if (!name || !comment || rating === 0) {
                showToast('Please fill in all fields and provide a rating.', 'error');
                return;
            }

            const review = {
                productId: productId,
                customerName: name,
                comment: comment,
                rating: rating
            };

            const success = await saveReviewToFirebase(review);
            if (success) {
                showToast('Review submitted! It will appear once approved.', 'success');
                resetReviewForm();
            } else {
                showToast('Failed to submit review.', 'error');
            }
        }

        async function loadModalReviews(productId) {
            const reviewsContainer = document.getElementById('reviewsList');
            const starsContainer = document.getElementById('modalAverageStars');
            reviewsContainer.innerHTML = '<p style="font-size: 0.8rem; color: var(--color-text-muted);">Loading reviews...</p>';

            if (typeof loadReviewsFromFirebase !== 'function') return;

            const reviews = await loadReviewsFromFirebase(productId);

            if (reviews.length === 0) {
                reviewsContainer.innerHTML = '<p style="font-size: 0.8rem; color: var(--color-text-muted); opacity: 0.6;">No reviews yet.</p>';
                starsContainer.innerHTML = '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ (0)';
                return;
            }

            const avg = reviews.reduce((acc, r) => acc + r.rating, 0) / reviews.length;
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                starsHtml += i <= Math.round(avg) ? '‚òÖ' : '‚òÜ';
            }
            starsContainer.innerHTML = `${starsHtml} (${reviews.length})`;

            reviewsContainer.innerHTML = reviews.map(r => `
                <div class="review-card">
                    <div class="review-meta">
                        <span class="review-author">${r.customerName}</span>
                        <div class="star-rating">
                            ${Array(5).fill(0).map((_, i) => i < r.rating ? '‚òÖ' : '‚òÜ').join('')}
                        </div>
                    </div>
                    <div class="review-comment">${r.comment}</div>
                    <div class="review-date" style="font-size: 0.65rem; margin-top: 5px;">${new Date(r.timestamp).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderDynamicInfo();
            displayWishlist();
            updateCounts();
        });

        document.getElementById('cartBtn').addEventListener('click', () => {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length > 0) window.location.href = 'checkout.html';
        });
    </script>
</body>

</html>